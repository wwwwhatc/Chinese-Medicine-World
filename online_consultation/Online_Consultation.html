<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ¨çº¿é—®è¯Šå¹³å°</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* è‡ªå®šä¹‰æ ·å¼ */
        body {
            background-color: #f7f9fc;
            color: #333;
        }
        .sidebar {
            min-height: 100vh;
        }
        .sidebar .nav-link.active {
            background-color: #556B2F;
            color: white;
        }
        .doctor-card img {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 1rem;
        }
        .modal-header .close {
            border: none;
            background: none;
        }
    </style>
</head>
<body>
    <div class="d-flex">
        <!-- ä¾§è¾¹æ  -->
        <nav class="sidebar bg-success text-white p-4 flex-shrink-0">
            <div class="mb-4 text-center fs-4 fw-bold">åœ¨çº¿é—®è¯Š</div>
            <ul class="nav nav-pills flex-column mb-auto">
                <li class="nav-item">
                    <a href="Online_Consultation1.html" class="nav-link text-white" aria-current="page">
                        AIæ™ºèƒ½é—®è¯Š
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#doctor-section" class="nav-link text-white">
                        é€‰æ‹©åŒ»ç”Ÿ
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#records-section" class="nav-link text-white">
                        é¢„çº¦è®°å½•
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/Chinese-Medicine-World/home/home.html" class="nav-link text-white">
                        è¿”å›é¦–é¡µ
                    </a>
                </li>
            </ul>
        </nav>

        <!-- ä¸»å†…å®¹åŒº -->
        <div class="flex-grow-1 p-4">
            <!-- ä¸»å¤´éƒ¨ -->
            <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
                <h1 class="mb-3">æ¬¢è¿ä½¿ç”¨åœ¨çº¿é—®è¯Šå¹³å°</h1>
                <div class="position-relative">
                    <input type="text" id="search-input" class="form-control rounded-pill" placeholder="æœç´¢åŒ»ç”Ÿæˆ–ç§‘å®¤...">
                    <span class="position-absolute top-50 end-0 translate-middle-y me-3">ğŸ”</span>
                </div>
            </div>

            <!-- åŒ»ç”Ÿåˆ—è¡¨ -->
            <section id="doctor-section" class="mb-5">
                <h2 class="mb-4 text-center">é€‰æ‹©åŒ»ç”Ÿ</h2>
                <div class="row row-cols-1 row-cols-md-3 g-4">
                    <!-- åŒ»ç”Ÿå¡ç‰‡ç¤ºä¾‹ -->
                    <div class="col">
                        <div class="card doctor-card h-100 text-center">
                            <img src="img/doctor1.jpg" class="card-img-top mx-auto mt-3" alt="æåŒ»ç”Ÿ" style="width:100px; height:100px;">
                            <div class="card-body">
                                <h5 class="card-title">æåŒ»ç”Ÿ</h5>
                                <p class="card-text">ä¸­åŒ»å†…ç§‘ä¸“å®¶</p>
                                <button class="btn btn-success reserve-btn">é¢„çº¦</button>
                            </div>
                        </div>
                    </div>
                    <!-- å…¶ä»–åŒ»ç”Ÿå¡ç‰‡... -->
                    <div class="col">
                        <div class="card doctor-card h-100 text-center">
                            <img src="img/doctor2.jpg" class="card-img-top mx-auto mt-3" alt="ç‹åŒ»ç”Ÿ" style="width:100px; height:100px;">
                            <div class="card-body">
                                <h5 class="card-title">ç‹åŒ»ç”Ÿ</h5>
                                <p class="card-text">é’ˆç¸ä¸æ¨æ‹¿ä¸“å®¶</p>
                                <button class="btn btn-success reserve-btn">é¢„çº¦</button>
                            </div>
                        </div>
                    </div>
                    <div class="col">
                        <div class="card doctor-card h-100 text-center">
                            <img src="img/doctor3.jpg" class="card-img-top mx-auto mt-3" alt="èµµåŒ»ç”Ÿ" style="width:100px; height:100px;">
                            <div class="card-body">
                                <h5 class="card-title">èµµåŒ»ç”Ÿ</h5>
                                <p class="card-text">ä¸­åŒ»å¦‡ç§‘ä¸“å®¶</p>
                                <button class="btn btn-success reserve-btn">é¢„çº¦</button>
                            </div>
                        </div>
                    </div>
                    <!-- æ–°å¢åŒ»ç”Ÿå¡ç‰‡ -->
                    <div class="col">
                        <div class="card doctor-card h-100 text-center">
                            <img src="img/doctor4.jpg" class="card-img-top mx-auto mt-3" alt="å­™åŒ»ç”Ÿ" style="width:100px; height:100px;">
                            <div class="card-body">
                                <h5 class="card-title">å­™åŒ»ç”Ÿ</h5>
                                <p class="card-text">ä¸­åŒ»å„¿ç§‘ä¸“å®¶</p>
                                <button class="btn btn-success reserve-btn">é¢„çº¦</button>
                            </div>
                        </div>
                    </div>
                    <div class="col">
                        <div class="card doctor-card h-100 text-center">
                            <img src="img/doctor5.jpg" class="card-img-top mx-auto mt-3" alt="å‘¨åŒ»ç”Ÿ" style="width:100px; height:100px;">
                            <div class="card-body">
                                <h5 class="card-title">å‘¨åŒ»ç”Ÿ</h5>
                                <p class="card-text">ä¸­åŒ»éª¨ç§‘ä¸“å®¶</p>
                                <button class="btn btn-success reserve-btn">é¢„çº¦</button>
                            </div>
                        </div>
                    </div>
                    <div class="col">
                        <div class="card doctor-card h-100 text-center">
                            <img src="img/doctor6.jpg
                            " class="card-img-top mx-auto mt-3" alt="å´åŒ»ç”Ÿ" style="width:100px; height:100px;">
                            <div class="card-body">
                                <h5 class="card-title">å´åŒ»ç”Ÿ</h5>
                                <p class="card-text">ä¸­åŒ»çš®è‚¤ç§‘ä¸“å®¶</p>
                                <button class="btn btn-success reserve-btn">é¢„çº¦</button>
                            </div>
                        </div>
                    </div>
                    <!-- å¯ä»¥æ ¹æ®éœ€è¦ç»§ç»­æ·»åŠ æ›´å¤šåŒ»ç”Ÿå¡ç‰‡ -->
                </div>
            </section>

            <!-- é¢„çº¦è®°å½• -->
            <section id="records-section" class="mb-5">
                <h2 class="mb-4 text-center">é¢„çº¦è®°å½•</h2>
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="records-table">
                        <thead class="table-success">
                            <tr>
                                <th scope="col">æ—¥æœŸ</th>
                                <th scope="col">åŒ»ç”Ÿ</th>
                                <th scope="col">ç§‘å®¤</th>
                                <th scope="col">çŠ¶æ€</th>
                                <th scope="col">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- é¢„çº¦è®°å½•å°†åŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
                        </tbody>
                    </table>
                </div>
            </section>
        </div>

        <!-- é¢„çº¦æ¨¡æ€çª—å£ -->
        <div class="modal fade" id="reserve-modal" tabindex="-1" aria-labelledby="reserveModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="reserveModalLabel">é¢„çº¦åŒ»ç”Ÿ</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="å…³é—­"></button>
                    </div>
                    <div class="modal-body">
                        <form id="reserve-form">
                            <div class="mb-3">
                                <label for="doctor-name" class="form-label">åŒ»ç”Ÿå§“å:</label>
                                <input type="text" id="doctor-name" name="doctor-name" class="form-control" readonly>
                            </div>
                            <div class="mb-3">
                                <label for="appointment-date" class="form-label">é¢„çº¦æ—¥æœŸ:</label>
                                <input type="date" id="appointment-date" name="appointment-date" class="form-control" required>
                            </div>
                            <button type="submit" class="btn btn-success">ç¡®è®¤é¢„çº¦</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç¼–è¾‘æ¨¡æ€çª—å£ -->
        <div class="modal fade" id="edit-modal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editModalLabel">ç¼–è¾‘é¢„çº¦</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="å…³é—­"></button>
                    </div>
                    <div class="modal-body">
                        <form id="edit-form">
                            <div class="mb-3">
                                <label for="edit-date" class="form-label">é¢„çº¦æ—¥æœŸ:</label>
                                <input type="date" id="edit-date" name="edit-date" class="form-control" required>
                            </div>
                            <button type="submit" class="btn btn-primary">ä¿å­˜ä¿®æ”¹</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bootstrap JS å’Œä¾èµ–é¡¹ï¼ˆPopperï¼‰ -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <!-- JavaScript å®ç°é¢„çº¦ä¸åˆ é™¤åŠŸèƒ½ -->
        <script>
            document.addEventListener('DOMContentLoaded', () => {
                const reserveButtons = document.querySelectorAll('.reserve-btn');
                const recordsTableBody = document.querySelector('#records-table tbody');
                const reserveModal = new bootstrap.Modal(document.getElementById('reserve-modal'));
                const editModal = new bootstrap.Modal(document.getElementById('edit-modal'));
                const reserveForm = document.getElementById('reserve-form');
                const editForm = document.getElementById('edit-form');
                const doctorNameInput = document.getElementById('doctor-name');
                const appointmentDateInput = document.getElementById('appointment-date');
                const editDateInput = document.getElementById('edit-date');
                let appointments = JSON.parse(localStorage.getItem('appointments')) || [];
                let currentEditIndex = null;

                // åŠ è½½é¢„çº¦è®°å½•ï¼ˆä» localStorageï¼‰
                appointments.forEach(app => addAppointmentToTable(app, false));
                updateAppointmentStatus();

                // ç»‘å®šé¢„çº¦æŒ‰é’®äº‹ä»¶
                reserveButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        const doctorCard = button.closest('.doctor-card');
                        const doctorName = doctorCard.querySelector('.card-title').textContent;
                        const department = doctorCard.querySelector('.card-text').textContent;

                        // æ‰“å¼€é¢„çº¦æ¨¡æ€çª—å£
                        doctorNameInput.value = doctorName;
                        appointmentDateInput.value = '';
                        reserveModal.show();
                    });
                });

                // é¢„çº¦è¡¨å•æäº¤äº‹ä»¶
                reserveForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const doctorName = doctorNameInput.value.trim();
                    const department = getDepartmentByDoctorName(doctorName);
                    const date = appointmentDateInput.value;

                    if (!date) {
                        alert('è¯·é€‰æ‹©é¢„çº¦æ—¥æœŸã€‚');
                        return;
                    }

                    const selectedDate = new Date(date);
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);

                    if (selectedDate < today) {
                        alert('é¢„çº¦æ—¥æœŸå¿…é¡»æ˜¯ä»Šå¤©æˆ–æœªæ¥çš„æ—¥æœŸã€‚');
                        return;
                    }

                    // æ£€æŸ¥æ˜¯å¦å·²æœ‰é‡å¤é¢„çº¦
                    const duplicate = appointments.some(app => app.doctor === doctorName && app.date === date);
                    if (duplicate) {
                        alert('æ‚¨å·²ç»åœ¨è¿™ä¸€å¤©é¢„çº¦äº†è¯¥åŒ»ç”Ÿã€‚');
                        return;
                    }

                    // åˆ›å»ºé¢„çº¦å¯¹è±¡
                    const appointment = {
                        date,
                        doctor: doctorName,
                        department,
                        status: 'å¾…ç¡®è®¤'
                    };

                    // æ·»åŠ åˆ°é¢„çº¦è®°å½•æ•°ç»„
                    appointments.push(appointment);
                    // ä¿å­˜åˆ° localStorage
                    localStorage.setItem('appointments', JSON.stringify(appointments));
                    // æ·»åŠ åˆ°è¡¨æ ¼
                    addAppointmentToTable(appointment, true);

                    // å…³é—­æ¨¡æ€çª—å£
                    reserveModal.hide();
                });

                // ç¼–è¾‘è¡¨å•æäº¤äº‹ä»¶
                editForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const newDate = editDateInput.value;

                    if (!newDate) {
                        alert('è¯·é€‰æ‹©é¢„çº¦æ—¥æœŸã€‚');
                        return;
                    }

                    const selectedDate = new Date(newDate);
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);

                    if (selectedDate < today) {
                        alert('é¢„çº¦æ—¥æœŸå¿…é¡»æ˜¯ä»Šå¤©æˆ–æœªæ¥çš„æ—¥æœŸã€‚');
                        return;
                    }

                    const appointment = appointments[currentEditIndex];
                    // æ£€æŸ¥æ˜¯å¦å·²æœ‰é‡å¤é¢„çº¦
                    const duplicate = appointments.some((app, index) => app.doctor === appointment.doctor && app.date === newDate && index !== currentEditIndex);
                    if (duplicate) {
                        alert('æ‚¨å·²ç»åœ¨è¿™ä¸€å¤©é¢„çº¦äº†è¯¥åŒ»ç”Ÿã€‚');
                        return;
                    }

                    // æ›´æ–°é¢„çº¦æ—¥æœŸ
                    appointment.date = newDate;

                    // æ›´æ–° localStorage
                    localStorage.setItem('appointments', JSON.stringify(appointments));

                    // æ›´æ–°è¡¨æ ¼
                    updateTableRow(currentEditIndex, appointment);

                    // å…³é—­æ¨¡æ€çª—å£
                    editModal.hide();
                });

                // å‡½æ•°ï¼šè·å–ç§‘å®¤ä¿¡æ¯é€šè¿‡åŒ»ç”Ÿå§“å
                function getDepartmentByDoctorName(name) {
                    const card = document.querySelector(`.doctor-card .card-title[text="${name}"]`);
                    const cardElement = Array.from(document.querySelectorAll('.doctor-card')).find(card => card.querySelector('.card-title').textContent === name);
                    return cardElement ? cardElement.querySelector('.card-text').textContent : '';
                }

                // å‡½æ•°ï¼šæ·»åŠ é¢„çº¦åˆ°è¡¨æ ¼
                function addAppointmentToTable(appointment, saveToLocal = true) {
                    const tr = document.createElement('tr');

                    const tdDate = document.createElement('td');
                    tdDate.textContent = appointment.date;
                    tr.appendChild(tdDate);

                    const tdDoctor = document.createElement('td');
                    tdDoctor.textContent = appointment.doctor;
                    tr.appendChild(tdDoctor);

                    const tdDepartment = document.createElement('td');
                    tdDepartment.textContent = appointment.department;
                    tr.appendChild(tdDepartment);

                    const tdStatus = document.createElement('td');
                    tdStatus.textContent = appointment.status;
                    tr.appendChild(tdStatus);

                    const tdAction = document.createElement('td');

                    // ç¼–è¾‘æŒ‰é’®
                    const editBtn = document.createElement('button');
                    editBtn.textContent = 'ç¼–è¾‘';
                    editBtn.classList.add('btn', 'btn-primary', 'btn-sm', 'me-2');
                    editBtn.addEventListener('click', () => {
                        currentEditIndex = appointments.indexOf(appointment);
                        editDateInput.value = appointment.date;
                        editModal.show();
                    });
                    tdAction.appendChild(editBtn);

                    // åˆ é™¤æŒ‰é’®
                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'åˆ é™¤';
                    deleteBtn.classList.add('btn', 'btn-danger', 'btn-sm');
                    deleteBtn.addEventListener('click', () => {
                        if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡é¢„çº¦è®°å½•å—ï¼Ÿ')) {
                            // ç§»é™¤é¢„çº¦è®°å½•
                            recordsTableBody.removeChild(tr);
                            // æ›´æ–° appointments æ•°ç»„
                            appointments = appointments.filter(app => !(app.date === appointment.date && app.doctor === appointment.doctor));
                            // æ›´æ–° localStorage
                            localStorage.setItem('appointments', JSON.stringify(appointments));
                        }
                    });
                    tdAction.appendChild(deleteBtn);

                    tr.appendChild(tdAction);

                    recordsTableBody.appendChild(tr);
                }

                // å‡½æ•°ï¼šæ›´æ–°è¡¨æ ¼è¡Œ
                function updateTableRow(index, appointment) {
                    const tr = recordsTableBody.children[index];
                    if (tr) {
                        tr.children[0].textContent = appointment.date;
                        tr.children[1].textContent = appointment.doctor;
                        tr.children[2].textContent = appointment.department;
                        tr.children[3].textContent = appointment.status;
                    }
                }

                // å‡½æ•°ï¼šæ›´æ–°é¢„çº¦çŠ¶æ€
                function updateAppointmentStatus() {
                    const today = new Date().toISOString().split('T')[0];
                    appointments.forEach((app, index) => {
                        if (app.date < today && app.status === 'å¾…ç¡®è®¤') {
                            app.status = 'å·²å®Œæˆ';
                            updateTableRow(index, app);
                        }
                    });
                    localStorage.setItem('appointments', JSON.stringify(appointments));
                }

                // æœç´¢åŠŸèƒ½ï¼ˆå¸¦é˜²æŠ–ï¼‰
                const searchInput = document.getElementById('search-input');
                let debounceTimeout;
                searchInput.addEventListener('input', () => {
                    clearTimeout(debounceTimeout);
                    debounceTimeout = setTimeout(() => {
                        const query = searchInput.value.toLowerCase();
                        const doctorCards = document.querySelectorAll('.doctor-card');
                        doctorCards.forEach(card => {
                            const name = card.querySelector('.card-title').textContent.toLowerCase();
                            const department = card.querySelector('.card-text').textContent.toLowerCase();
                            if (name.includes(query) || department.includes(query)) {
                                card.parentElement.style.display = 'block';
                            } else {
                                card.parentElement.style.display = 'none';
                            }
                        });
                    }, 300);
                });
            });
        </script>
    </body>
</html>
